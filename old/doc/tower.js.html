<!DOCTYPE html>

<html lang="en">
<head>
	<meta charset="utf-8">
	<title>Three Arena Source: elements/tower.js</title>

	<!--[if lt IE 9]>
	<script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
	<![endif]-->
	<link type="text/css" rel="stylesheet" href="styles/sunlight.default.css">

	
	<link type="text/css" rel="stylesheet" href="styles/site.flatly.css">
	
</head>

<body>
<div class="container-fluid">
	<div class="navbar navbar-fixed-top navbar-inverse">
		<div class="navbar-inner">
			<a class="brand" href="index.html">Three Arena</a>
			<ul class="nav">
				
				<li class="dropdown">
					<a href="modules.list.html" class="dropdown-toggle" data-toggle="dropdown">Modules<b
						class="caret"></b></a>

					<ul class="dropdown-menu ">
						
						<li>
							<a href="bufficon.html">threearena/elements/bufficon</a>
						</li>
						
						<li>
							<a href="lifebar.html">threearena/elements/lifebar</a>
						</li>
						
						<li>
							<a href="nexus.html">threearena/elements/nexus</a>
						</li>
						
						<li>
							<a href="shop.html">threearena/elements/shop</a>
						</li>
						
						<li>
							<a href="sound.html">threearena/elements/sound</a>
						</li>
						
						<li>
							<a href="terrain.html">threearena/elements/terrain</a>
						</li>
						
						<li>
							<a href="tower.html">threearena/elements/tower</a>
						</li>
						
						<li>
							<a href="toxi.html">threearena/elements/toxi</a>
						</li>
						
						<li>
							<a href="water.html">threearena/elements/water</a>
						</li>
						
						<li>
							<a href="demo.html">threearena/examples/demo</a>
						</li>
						
						<li>
							<a href="game.html">threearena/game</a>
						</li>
						
						<li>
							<a href="hud.html">threearena/hud</a>
						</li>
						
						<li>
							<a href="log.html">threearena/log</a>
						</li>
						
						<li>
							<a href="cloud.html">threearena/particles/cloud</a>
						</li>
						
						<li>
							<a href="flies.html">threearena/particles/flies</a>
						</li>
						
						<li>
							<a href="shadercloud.html">threearena/particles/shadercloud</a>
						</li>
						
						<li>
							<a href="snow.html">threearena/particles/snow</a>
						</li>
						
						<li>
							<a href="circles.html">threearena/shaders/circles</a>
						</li>
						
						<li>
							<a href="lightbolt.html">threearena/shaders/lightbolt</a>
						</li>
						
						<li>
							<a href="bite.html">threearena/spell/bite</a>
						</li>
						
						<li>
							<a href="fireaura.html">threearena/spell/fireaura</a>
						</li>
						
						<li>
							<a href="firebullet.html">threearena/spell/firebullet</a>
						</li>
						
						<li>
							<a href="flatfireaura.html">threearena/spell/flatfireaura</a>
						</li>
						
						<li>
							<a href="lightbolt_.html">threearena/spell/lightbolt</a>
						</li>
						
						<li>
							<a href="entityview.html">threearena/views/entityview</a>
						</li>
						
						<li>
							<a href="gameview.html">threearena/views/gameview</a>
						</li>
						
						<li>
							<a href="interactiveview.html">threearena/views/interactiveview</a>
						</li>
						

					</ul>
				</li>
				
				<li class="dropdown">
					<a href="classes.list.html" class="dropdown-toggle" data-toggle="dropdown">Classes<b
						class="caret"></b></a>

					<ul class="dropdown-menu ">
						
						<li>
							<a href="character.html">threearena/character</a>
						</li>
						
						<li>
							<a href="007.html">threearena/character/007</a>
						</li>
						
						<li>
							<a href="human.html">threearena/character/human</a>
						</li>
						
						<li>
							<a href="monsterdog.html">threearena/character/monsterdog</a>
						</li>
						
						<li>
							<a href="ogro.html">threearena/character/ogro</a>
						</li>
						
						<li>
							<a href="ratamahatta.html">threearena/character/ratamahatta</a>
						</li>
						
						<li>
							<a href="attackcircle.html">threearena/controls/attackcircle</a>
						</li>
						
						<li>
							<a href="dota.html">threearena/controls/dota</a>
						</li>
						
						<li>
							<a href="selection.html">threearena/controls/selection</a>
						</li>
						
						<li>
							<a href="abovemark.html">threearena/elements/abovemark</a>
						</li>
						
						<li>
							<a href="autospawn.html">threearena/elements/autospawn</a>
						</li>
						
						<li>
							<a href="interactiveobject.html">threearena/elements/interactiveobject</a>
						</li>
						
						<li>
							<a href="entity.html">threearena/entity</a>
						</li>
						
						<li>
							<a href="game_.html">threearena/game</a>
						</li>
						
						<li>
							<a href="spell.html">threearena/spell</a>
						</li>
						
						<li>
							<a href="destinationmarker.html">threearena/spell/destinationmarker</a>
						</li>
						

					</ul>
				</li>
				
				<li class="dropdown">
					<a href="events.list.html" class="dropdown-toggle" data-toggle="dropdown">Events<b
						class="caret"></b></a>

					<ul class="dropdown-menu ">
						
						<li>
							<a href="game.html#event:added:entity">added:entity</a>
						</li>
						
						<li>
							<a href="game.html#event:added:spawningpool">added:spawningpool</a>
						</li>
						
						<li>
							<a href="game.html#event:added:static">added:static</a>
						</li>
						
						<li>
							<a href="game.html#event:ready">ready</a>
						</li>
						
						<li>
							<a href="game.html#event:start">start</a>
						</li>
						
						<li>
							<a href="game.html#event:update">update</a>
						</li>
						
						<li>
							<a href="game.html#event:update:behaviours">update:behaviours</a>
						</li>
						

					</ul>
				</li>
				
				<li class="dropdown">
					<a href="global.html" class="dropdown-toggle" data-toggle="dropdown">Global<b
						class="caret"></b></a>

					<ul class="dropdown-menu ">
						
						<li>
							<a href="global.html#gcb">gcb</a>
						</li>
						
						<li>
							<a href="global.html#glow">glow</a>
						</li>
						
						<li>
							<a href="global.html#glowmaterial">glowmaterial</a>
						</li>
						
						<li>
							<a href="global.html#moveAlong">moveAlong</a>
						</li>
						
						<li>
							<a href="global.html#unglow">unglow</a>
						</li>
						

					</ul>
				</li>
				
			</ul>
		</div>
	</div>

	<div class="row-fluid">

		
			<div class="span12">
				
				<div id="main">
					


		<h1 class="page-title">Source: elements/tower.js</h1>
    
    <section>
        <article>
            <pre class="sunlight-highlight-javascript linenums">define('threearena/elements/tower',
    ['lodash', 'threejs', 'threearena/particles/cloud', 'threearena/spell', 'threearena/entity'], function(_, THREE, Particles, Spell) {

    /**
     * @constructor
     * @exports threearena/elements/tower
     */
    var DefenseTower = function( x, y, z, options ) {

        THREE.Object3D.apply( this );

        var self = this,

            x = x ||  0,
            y = y || 28,
            z = z ||  1,
            options = options || {}
            ;

        this.bulletSpeed = options.bulletSpeed || 10;
        this.fireSpeed = options.fireSpeed || 1;

        this.magicLifeDamage = options.magicLifeDamage || 1;
        this.manaDamage = options.magicManaDamage || 1;

        /////

        this._firing = false;
        this._currentTweens = [];

        this.options = _.merge({
                    start: true,
                 minRange: 0,
                 maxRange: 70,
            fireIntensity: 20000,
               orbTexture: options.texture || THREE.ImageUtils.loadTexture( "/gamedata/textures/lensflare1_alpha.png" ),
              fireTexture: options.texture || THREE.ImageUtils.loadTexture( "/gamedata/textures/lensflare0_alpha.png" ),
        } , options );

        // self.fireCloud = new ParticleCloud( 10000, self.options.fireTexture );

        var loader = new THREE.ColladaLoader();
        loader.load( '/gamedata/lantern.dae', function ( loaded ) {

            self.aura = Particles.Aura( 'point', self.options.fireIntensity, self.options.orbTexture, null );
            self.aura.particleCloud.position.set( x, y+28, z );
            self.add( self.aura.particleCloud );
            
            var lantern = loaded.scene.children[ 0 ];
            lantern.castShadow = true;
            lantern.rotation.x = -90 * Math.PI / 180;
            lantern.scale.set(7, 7, 7);
            lantern.position.set(x, y, z);
            delete loaded;

            self.add(lantern);

            var selfUpdate = _.bind(self.update, self);

            if (self.options.start) {
                self.aura.start();
                
                window._ta_events.bind('update', selfUpdate);
            }
        });
    };
    DefenseTower.prototype = new THREE.Object3D();

    DefenseTower.prototype.update = function(game) {

        var self = this;

        if (this.aura) {
            this.aura.update(game.delta);
        }

        if (this._firing) return;

        var i = -1, charDistance, minDistance = Number.MAX_VALUE, nearest = false;
        while (i++ &lt; game.pcs.length - 1 && !this._firing) {
            if (game.pcs[i].isDead()) continue;

            charDistance = game.pcs[i].position.distanceTo(self.position);
            if (charDistance >= self.options.minRange && charDistance &lt; self.options.maxRange 
                && charDistance &lt; minDistance) {
                nearest = i;
                minDistance = charDistance;
            }
        }
        nearest !== false && ! this._firing && self.fireTo( game.pcs[ nearest ] );
    };

    DefenseTower.prototype.stopFiring = function( target ) {
        this._firing = false;
    };

    DefenseTower.prototype.fireTo = function(target) {

        if (this._firing || ! target instanceof Entity) return;
        this._firing = true;
        
        var startPosition = this.position.clone().setY(35);
        var vectorPosition = target.position.clone().add(startPosition).divideScalar(2).setY(28 + 0);

        var self = this,
            line = new THREE.SplineCurve3([ startPosition, vectorPosition, target.position ]),
            cloud = new Particles.ParticleCloud( 10000, self.options.fireTexture, null, {
                // colorHSL: .5
            }),
            cloudUpdate = _.bind(function(game){
                cloud.update(game.delta);
            }, cloud)
            ;

        var tween = new TWEEN.Tween({ distance: 0 })

            .to({ distance: 1 }, line.getLength() * self.bulletSpeed) // use 

            .easing(TWEEN.Easing.Quadratic.InOut)

            .onStart(function(){
                window._ta_events.bind('update', cloudUpdate);

                self.add(cloud.particleCloud);
                cloud.start();

                setTimeout(function(){
                    self._firing = false;

                }, 4000 / self.fireSpeed);

                setTimeout(function(){
                    if (tween) { tween.stop(); }
                    window._ta_events.unbind('update', cloudUpdate);

                    self.remove(cloud.particleCloud);
                }, 1000 );
            })
            
            .onComplete(function(){
                window._ta_events.unbind('update', cloudUpdate);

                self.remove(cloud.particleCloud);
                cloud.stop();
                // self._firing = false;
                delete cloud;

                var spell = new Spell({
                    name: 'firebullet',
                    source: self,
                    magicLifeDamage: self.magicLifeDamage,
                    manaDamage: self.manaDamage,
                });
                target.hit(spell);
            })
            
            .onUpdate(function(){
                // get the position data half way along the path
                var pathPosition = line.getPoint(this.distance);

                // move to that position
                cloud.particleCloud.position.set(pathPosition.x * .9, pathPosition.y * .9, pathPosition.z * .9);
                // cloud.emitterpos.set(pathPosition.x * 0.01, pathPosition.y * 0.01, pathPosition.z * 0.01);

                // cloud.emitterpos.set(pathPosition.x, pathPosition.y, pathPosition.z);

                cloud.particleCloud.updateMatrix();
            })
            .start();
    };

    DefenseTower.prototype.constructor = THREE.DefenseTower;

    return DefenseTower;

});
</pre>
        </article>
    </section>





				</div>

				<div class="clearfix"></div>
				<footer>
					
					
		<span class="jsdoc-message">
		Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.2.0</a>
		on Sat Dec 07 2013 18:26:49 GMT+0100 (CET) using the <a href="https://github.com/terryweiss/docstrap">DocStrap template</a>.
		</span>
				</footer>
			</div>

			
			<br clear="both">
		</div>

	</div>
	<script src="scripts/sunlight.js"></script>
	<script src="scripts/sunlight.javascript.js"></script>
	<script src="scripts/sunlight-plugin.doclinks.js"></script>
	<script src="scripts/sunlight-plugin.linenumbers.js"></script>
	<script src="scripts/sunlight-plugin.menu.js"></script>
	<script src="scripts/jquery.min.js"></script>
	<script src="scripts/jquery.scrollTo.js"></script>
	<script src="scripts/jquery.localScroll.js"></script>
	<script src="scripts/bootstrap-dropdown.js"></script>
	<script src="scripts/toc.js"></script>


	<script>  Sunlight.highlightAll({lineNumbers:true,  showMenu: true, enableDoclinks :true}); </script>

	<script>
		$( function () {
			$( "#toc" ).toc( {
				selectors   : "h1,h2,h3,h4",
				showAndHide : false,
				scrollTo    : 60
			} );
			$( "#toc>ul" ).addClass( "nav nav-pills nav-stacked" );
			$( "#main span[id^='toc']" ).addClass( "toc-shim" );

		} );
	</script>

	

</body>
</html>
